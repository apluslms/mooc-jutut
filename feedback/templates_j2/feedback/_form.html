{% set form_id = form.auto_id|format("form_" ~ get_random_string(8)) -%}
{#
  Template for bootstrap glyph
-#}
{% macro glyph(name, arialabel=none) -%}
	<span class="bi bi-{{name}}"
		{%- if arialabel-%}
			aria-label="{{ arialabel }}"
		{%- else -%}
			aria-hidden="true"
		{%- endif -%}
	></span>
{% endmacro -%}
{#
  Ensure input/textarea widgets get Bootstrap 5 form-control
-#}
{% macro render_control(field) -%}
	{%- set w = field.field.widget -%}
	{%- set input_type = w.input_type if w.input_type is defined else None -%}
	{%- set is_textarea = 'Textarea' in w.__class__.__name__ -%}
	{%- set excluded = ['checkbox','radio','file','hidden','range','submit','reset','button','image'] -%}
	{%- set make_control = is_textarea or (input_type and (input_type not in excluded)) -%}
	{%- if make_control -%}
		{%- set existing = w.attrs.get('class','') -%}
		{%- set new_class = (existing ~ (' ' if existing else '') ~ 'form-control') -%}
		{{ field.as_widget(attrs={'class': new_class}) }}
	{%- else -%}
		{{ field }}
	{%- endif -%}
{%- endmacro -%}
{#
  Staff reponse template
-#}
{% macro staff_response(message, index=0) -%}
	{% if message %}
		<li class="list-group-item list-group-item-info staff{% if index > 2 %} initially-hidden{% endif %}">
			{{ glyph("mortarboard-fill", _("teacher")) }}
			<span class="text">{{ message|safe }}</span>
		</li>
	{% endif %}
{%- endmacro -%}
{#
  Student message template
-#}
{% macro student_message(messages, f_key, index=0) -%}
	{# messages is a list of (key, text) tuples per Feedback.text_feedback #}
	{%- for pair in messages -%}
		{%- set k = pair[0] -%}
		{%- set val = pair[1] -%}
		{%- if k == f_key and val -%}
			<li class="list-group-item student{% if index > 2 %} initially-hidden{% endif %}">
				<span class="text">{{ val|safe }}</span>
			</li>
		{%- endif -%}
	{%- endfor -%}
{%- endmacro -%}
{% macro well(older_count, show_teacher=true, f_key=none) -%}
	{%- if show_teacher -%}
		{% set sr_text = _("Previous responses and teacher replies") %}
	{%- else -%}
		{% set sr_text = _("Previous responses") %}
	{%- endif -%}
	<div class="history-well mb-2 p-2 border rounded bg-body-secondary">
		<span class="visually-hidden">{{ sr_text }}</span>
		<ul class="list-group nav mb-0">
			{% if older_count > 2 -%}
				<li class="show-more mb-2">
					{{ glyph("chevron-up") }} {{ _("show more") }} {{ glyph("chevron-down") }}
				</li>
			{%- endif %}

			{%- for oldfb in feedback.older_versions|reverse -%}
				{%- if f_key -%}
					{{ student_message(oldfb.text_feedback, f_key, loop.revindex) }}
				{%- endif -%}
				{%- if show_teacher -%}
					{{ staff_response(oldfb.response_msg, loop.revindex) }}
				{%- endif -%}
			{%- endfor -%}

			{%- if f_key-%}
				{{ student_message(feedback.text_feedback, f_key) }}
			{%- endif -%}
			{%- if feedback.response_msg and show_teacher -%}
				{{ staff_response(feedback.response_msg) }}
			{%- endif -%}
		</ul>
	</div>
{%- endmacro -%}
{#
	Generic field renderer for Bootstrap 5 (replaces |bootstrap and |bootstrap_classes filters from django-bootstrap-form)
-#}

{% macro render_field(field) -%}
	<div class="mb-3">
		{%- if field.auto_id and field.label -%}
			<label class="form-label {% if field.field.required %}{{ form.required_css_class or 'required' }}{% endif %}" for="{{ field.auto_id }}">{{ field.label }}</label>
		{%- endif -%}
		{%- if field.help_text -%}
			<div class="form-text">{{ field.help_text|safe }}</div>
		{%- endif -%}
		{{ render_control(field) }}
		{%- for error in field.errors -%}
			<div class="invalid-feedback d-block">{{ error }}</div>
		{%- endfor -%}
	</div>
{%- endmacro -%}
{#
  Main block
-#}
<div class="jutut-exercise jutut-v2" lang="{{ get_current_language() }}">
	{#- Form -#}
	<form id="{{ form_id }}" action="{{ post_url }}" method="post" class="form">
		{%- if feedback -%}
			{% set older_count = feedback.older_versions.count() %}
			{%- if form is has_textfields -%}

				{%- if form.non_field_errors() -%}
					<div class="alert alert-danger alert-dismissible fade show" role="alert">
						{%- for non_field_error in form.non_field_errors() -%}
							{{ non_field_error }}
						{%- endfor -%}
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Close') }}"></button>
					</div>
				{%- endif -%}

				{%- for field in form -%}
					{%- if field.is_text -%}
						<div class="mb-3">
							<div class="{{ field.css_classes() }}">
								{%- if field.auto_id and field.label -%}
									<label class="form-label {% if field.field.required %}{{ form.required_css_class or 'required' }}{% endif %}" for="{{ field.auto_id }}">{{ field.label }}</label>
								{%- endif -%}
								{%- if field.help_text -%}
									<div class="form-text">
										{{ field.help_text|safe }}
									</div>
								{%- endif -%}
								{#- Old versions and teacher responses (if main text feedback) -#}
								{{ well(older_count, field is primary_textfeedback, field.name) }}
								{{ render_control(field) }}
								{%- for error in field.errors -%}
									<div class="invalid-feedback d-block">{{ error }}</div>
								{%- endfor -%}
							</div>
						</div>
					{%- else -%}
						{{ render_field(field) }}
					{%- endif -%}
				{%- endfor -%}
			{%- else -%} {# render possible teacher responses even though there isn't text feedback -#}
				{{ well(older_count) }}
				{%- for field in form -%}
					{{ render_field(field) }}
				{%- endfor -%}
			{%- endif -%}
		{%- else -%}
			{%- for field in form -%}
				{{ render_field(field) }}
			{%- endfor -%}
		{%- endif -%}

		<div class="only-when-edited alert alert-warning" style="display: none;">
			{{ _("This feedback has unsaved changes!") }}
		</div>

		<div id="feedback-received-message" class="alert alert-info" style="display: none">
			{{ _("Feedback received.") }}
		</div>

		<div class="btn-toolbar gap-2">
			<input
				type="submit"
				value="{{ _('Submit') }}"
				class="btn btn-primary aplus-submit mr-2">
			<input
				type="reset"
				value="{{ _('Reset changes') }}"
				class="btn btn-danger only-when-edited">
		</div>
	</form>

	{# UI interaction #}
	<script>
		(function($) {
			const f = $('#{{ form_id }}');
			// implement feedback received notification
			// needs to be only shown when feedback has just been sent by student
			const feedbackJustReceived = f.closest('.exercise-response').data('aplus-grader-feedback-just-received');
			if (feedbackJustReceived) {
				$('#feedback-received-message').show();
			}
			// implement show more
			const c = f.find('.history-well'), m = c.find('.show-more');
			m.click(function() { c.find('li.initially-hidden').removeClass('initially-hidden').show(); m.hide(); });
			// empty textfields
			c.next('textarea, input[type="text"]').val("");
			// implement edited notification
			const o = f.find('.only-when-edited'), i = f.serialize();
			let s = false;
			f.removeAttr('id');
			f.find(':input').on('change input', function() {
				const n = f.serialize() !== i;
				if (s !== n) o.toggle(s = n);
			});
			f.find("input[type='reset']").on('click', function(e) {
				e.preventDefault();
				f.each(function(){this.reset();});
				c.next('textarea, input[type="text"]').val("");
				o.hide(); s = false;
			});
			o.hide();
			// inject styles
			if ($('#jutut-v2').length==0)
				$('<style id="jutut-v2"></style>').appendTo(document.head).text(
					".jutut-exercise.jutut-v2 .history-well { padding: 6px; } " +
					".jutut-exercise.jutut-v2 li.initially-hidden { display: none; } " +
					".jutut-exercise.jutut-v2 .show-more { margin: 0 0 -6px; padding: 0; text-align: center; cursor: pointer; } " +
					".jutut-exercise.jutut-v2 li { margin: 3px 0; border-radius: 4px; } " +
					".jutut-exercise.jutut-v2 li .text { white-space: pre-wrap; } " +
					".jutut-exercise.jutut-v2 li.staff { margin-left: 15%; padding-left: 32px; position: relative; } " +
					".jutut-exercise.jutut-v2 li.staff .bi { position: absolute; left: 12px; } " +
					".jutut-exercise.jutut-v2 li.student { margin-right: 15%;} " +
					".modal-content .jutut-exercise.jutut-v2 li.student:not(:has(~ .student)) { border: solid 2px #66afe9; } "
				);
		})(jQuery);
	</script>
</div>
